<!DOCTYPE html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="static/css/bootstrap.min.css" />
<link rel="stylesheet" href="static/css/d3.slider.css" />
<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.vth {
    fill: none;
    stroke: red;
    stroke-width: 1;
    stroke-dasharray: 3, 3;
}

dt {
    margin-top: 20px;
}
</style>
</head>
<body>
<div class="container">
    <div class="col-sm-8">
    <div id="chart"></div>
</div>
<div class="col-sm-4">
    <div class="container-fluid">
        <h2 div="page-header">Nest web interface</h2>

        <dl>
            <dt>Input mean</dt><dd id="mean"></dd>
            <dt>Input standard deviation</dt><dd id="std"></dd>
            <dt>Membrane capacitance</dt><dd id="C_m"></dd>
            <dt>Membrane time constant</dt><dd id="tau_m"></dd>
        </dl>

        <p style="margin-top:50px">
        <button id="run" class="btn btn-default">Run</button>
        <button id="stop" class="btn btn-default">Stop</button>
        <p>
    </div>
</div>
</div>
    <script type="text/javascript" src="static/js/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="static/js/d3.min.js"></script>
    <script type="text/javascript" src="static/js/d3.slider.js"></script>

    <script>
    var run = false;

    $('#run').on('click', function() {
        run = true;
        tick();
    })

    $('#stop').on('click', function() {
        run = false;
    })

    var param = {};

    function slider(ref, min, max, val) {
        param[ref] = val
        d3.select('#'+ref).call(
            d3.slider()
            .min(min)
            .max(max)
            .value(val)
            .axis(true)
            .on("slide", function(evt, value) {
                param[ref] = value;
            })
        );
    }

    slider('mean', 0, 400, 100)
    slider('std', 0, 1000, 100)
    slider('tau_m', 0, 20, 10)
    slider('C_m', 0, 300, 200)

    var margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = 760 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var xScale = d3.scale.linear()
        .range([0, width]);

    var yScale = d3.scale.linear()
        .range([height, 0]);

    var xAxis = d3.svg.axis()
        .scale(xScale)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(yScale)
        .orient("left");

    var line = d3.svg.line()
        .x(function(d) { return xScale(d.x); })
        .y(function(d) { return yScale(d.y); });

    var vth_line = d3.svg.line()
        .x(function(d) { return xScale(d.x); })
        .y(function(d) { return yScale(-55.); });


    var svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    svg.append("defs").append("clipPath")
        .attr("id", "clip")
      .append("rect")
        .attr("width", width)
        .attr("height", height);

    var data = {{ data|safe }};

    xScale.domain(d3.extent(data, function(d) { return d.x; }));
    yScale.domain(d3.extent(data, function(d) { return d.y })).nice(10);

    svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

    svg.append("g")
      .attr("class", "y axis")
      .call(yAxis);

    svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "middle")
        .attr("x", width/2)
        .attr("y", height+margin.bottom-5)
        .text("Time (ms)");

    svg.append("text")
        .attr("class", "y label")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .attr("text-anchor", "end")
        .text("Membrane potential (mV)");

    var path = svg.append("g")
        .attr("clip-path", "url(#clip)")
      .append("path")
        .datum(data)
        .attr("class", "line")
        .attr("d", line);

    var vth_path = svg.append("g")
            .attr("clip-path", "url(#clip)")
          .append("path")
            .datum(data)
            .attr("class", "vth line")
            .attr("d", vth_line);

    function tick() {

        if (run) {
            // push a new data point onto the back
            $.ajax({
                method: "GET",
                url: "simulate/",
                data: param,
            }).done(function(res) {
                data = data.concat(res.data)
            })

            var xmax = d3.max(data, function(d) { return d.x })
            xScale.domain([xmax-1000,xmax]);
            yScale.domain(d3.extent(data, function(d) { return d.y })).nice(10);

            d3.select(".x.axis")
                .transition()
                .duration(300)
                .ease("linear")
                .call(xAxis);

            d3.select(".y.axis")
                .transition()
                .duration(1000)
                .ease("linear")
                .call(yAxis);

            vth_path.datum(data)
                .attr("d", vth_line);

            path.datum(data)
                .attr("d", line)
                .attr("transform", null)
                .transition()
                .duration(0)
                .ease("linear")
                .attr("transform", "translate(" + xScale(-1) + ",0)")
                .each("end", tick);
              // pop the old data point off the front

              data.shift();

        }

    }
    </script>

</body>
</html>
